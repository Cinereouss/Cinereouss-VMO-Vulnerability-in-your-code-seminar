//Same for all javascritp template tengines
const express = require('express');
const lodash = require('lodash');
var bodyParser = require('body-parser');
var ejs = require('ejs');
const PORT = 8082

const app = express();
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));

app.set("views","./templates");
app.set("view engine","ejs");

const VMO_DIVISION = ['DU18', 'DU2', 'DU3', 'DU5', 'DU10', 'DU11', 'DU12']

function getPermissions(){
    //**
    // Execute to get the user's rights, if there is no return {}
    // */
    return {}
}

app.post('/', (request, response) => {
    let data = {};
    let input = JSON.parse(request.body.data);
    lodash.defaultsDeep(data, input)
    //**
    // Execute something
    // */
    response.json({message: "OK"});
})

app.get('/', (request, response) => {
    let user = getPermissions()
    if(user.isAdmin) {
        return response.render("admin", request.query);
    } else {
        return response.render("unauthorized");
    }
})

app.get('/guess-division', (request, response) => {
    const { guesses } = request.query;
    const matches = [];

    for (var i = 0; i < guesses.length; i++){
        if (VMO_DIVISION.includes(guesses[i])) {
            matches.push(guesses[i])
        }
    }

    response.json({matches});
})

app.listen(PORT, (err) => {
    if (err) {
        return console.log('something bad happened', err)
    }
    console.log(`server is listening on ${PORT}`)
})

